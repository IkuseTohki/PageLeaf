# PageLeaf エディタ機能詳細仕様書

## 1. 概要

本アプリケーションのエディタは、Markdown ドキュメントの執筆効率を最大化するため、VS Code 等のモダンなエディタに近い操作感と入力支援を提供することを目的とする。

## 2. コア・コンポーネント

- **エディタエンジン**: AvalonEdit (ICSharpCode.AvalonEdit)
- **文字コード**: UTF-8 (BOMなし推奨)
- **レンダリング**: リアルタイム・シンタックスハイライトおよび行番号表示

## 3. 表示仕様 (Visuals)

### 3.1. シンタックスハイライト仕様

AvalonEdit 上で以下の要素が構造的に認識され、色分け表示される。

| 要素                  | スタイル定義            | 備考                     |
| :-------------------- | :---------------------- | :----------------------- |
| **見出し**            | 青色 (`#007ACC`) / 太字 | `#` で始まる行           |
| **コードブロック**    | 茶色 (`#CE9178`)        | ` ``` ` で囲まれた範囲   |
| **引用**              | 緑色 (`#608B4E`)        | `>` で始まる行           |
| **リスト記号**        | 黄土色 (`#DCDCAA`)      | `*`, `-`, `+`, `1.` 等   |
| **強調（太字/斜体）** | 太字 / 斜体             | `**`, `*` で囲まれた範囲 |
| **リンク/URL**        | 青色 (`#569CD6`)        | `[text](url)` 形式       |

### 3.2. エディタ設定

- **行番号**: エディタ左端に表示。
- **折り返し**: ウィンドウ幅に応じたワードラップ。
- **フォント**: 設定画面より指定されたフォントファミリおよびサイズを適用。

## 4. 自動入力支援 (Auto-Input Support)

### 4.1. リスト・引用の自動継続

改行（Enter）時に直前の行の構造を解析し、プレフィックスを自動挿入する。

| 入力中の行の状態      | トリガー | 期待される動作（次行の状態）               |
| :-------------------- | :------- | :----------------------------------------- |
| `* item` (箇条書き)   | `Enter`  | `* ` (記号と半角スペースを挿入)            |
| `1. item` (番号付き)  | `Enter`  | `2. ` (番号をインクリメントして挿入)       |
| `- [ ] task` (未完了) | `Enter`  | `- [ ] ` (空のタスクリストを挿入)          |
| `- [x] task` (完了)   | `Enter`  | `- [ ] ` (未完了状態でタスクリストを挿入)  |
| `> quote` (引用)      | `Enter`  | `> ` (引用記号を挿入)                      |
| `* ` (記号のみの状態) | `Enter`  | 行頭記号を削除し、通常の改行（空行）とする |
| `> ` (引用記号のみ)   | `Enter`  | 引用記号を削除し、通常の改行（空行）とする |

### 4.2. オートペアリング (括弧・引用符の補完)

特定の記号を入力した際、対応する閉じ記号を自動挿入する。

| 入力記号 | 選択範囲     | 期待される動作            | 挿入後のカーソル位置 |
| :------- | :----------- | :------------------------ | :------------------- |
| `(`      | なし         | `()` を挿入               | 括弧の間             |
| `[`      | なし         | `[]` を挿入               | 括弧の間             |
| `"`      | なし         | `""` を挿入               | 引用符の間           |
| `(`      | あり(`text`) | `(text)` (選択範囲を囲む) | 閉じ括弧の後         |
| `[`      | あり(`text`) | `[text]` (選択範囲を囲む) | 閉じ括弧の後         |

## 5. テーブル編集支援 (Table Editing Support)

### 5.1. 自動フォーマット

- **トリガー**: テーブル行（行内に `|` を含む行）で `Enter` または `Tab` を押下した際。
- **振る舞い**:
  - パイプ `|` の周囲を整形し、各セルの内容の前後に1つの半角スペースを配置する。
  - エスケープされたパイプ `\|` は区切り文字として認識せず、整形対象外（コンテンツの一部）とする。
  - **例**: `|a|b|` → `| a | b |`

### 5.2. セル間移動

- **トリガー**: `Tab`（次へ）または `Shift + Tab`（前へ）を押下した際。
- **振る舞い**:
  - 隣のセルの開始位置（パイプの後のスペースの次）へ移動する。
  - **セルの自動選択**: 移動先のセルの内容（前後のスペースを除く）を**選択状態**にする。これにより、即座に上書き入力が可能。
  - 行末のセルの場合、`Tab` 押下で行末（最後のパイプの後）に移動する。

## 6. ショートカットキー

| キー操作           | 機能                     | 詳細動作                                                            |
| :----------------- | :----------------------- | :------------------------------------------------------------------ |
| `Ctrl + B`         | **太字**                 | 選択範囲を `**` で囲む。すでに囲まれている場合は解除。              |
| `Ctrl + I`         | _斜体_                   | 選択範囲を `*` で囲む。すでに囲まれている場合は解除。               |
| `Ctrl + Shift + X` | ~~打ち消し線~~           | 選択範囲を `~~` で囲む。                                            |
| `Ctrl + Shift + C` | `インラインコード`       | 選択範囲を `` ` `` で囲む。                                         |
| `Ctrl + K`         | リンク挿入               | `[選択範囲]()` を作成。カーソルは `()` 内へ移動。                   |
| `Ctrl + L`         | **タスクリストのトグル** | `[ ]` (未完了) → `[x]` (完了) → `(なし)` の3段階トグル。            |
| `Ctrl + Alt + F`   | **脚注挿入**             | ポップアップを表示し、参照マーカーと定義を一括挿入する。            |
| `Ctrl + 1〜6`      | 見出しレベル変更         | 行頭にレベルに応じた `#` を付与。現在のレベルと同じなら解除。       |
| `Shift + Enter`    | 強制改ページ挿入         | 印刷用タグ `<div style="page-break-after: always;"></div>` を挿入。 |
| `Alt+Shift+←/→`    | 表示モード切替           | 編集モード(Markdown) と 閲覧モード(Viewer) を切り替える。           |

## 7. 脚注支援 (Footnote Support)

### 7.1. インライン入力 UX

- **トリガー**: `Ctrl + Alt + F`
- **挙動**: カーソル位置の直下に、コンパクトな入力ポップアップを表示する。
  - **フォーカス制御**: 表示中はポップアップ内の入力欄にフォーカスを拘束する。
  - **Light-dismiss**: ポップアップ外をクリックしたり、フォーカスが外れた場合は「キャンセル」とみなし、何も挿入せずに閉じる。
- **入力確定**: テキストを入力して `Enter` を押下すると、以下を一括で行う。
  1. 本文のカーソル位置に参照マーカー `[^n]` を挿入。
  2. ドキュメントの末尾に定義行 `[^n]: (入力内容)` を追記。
- **キャンセル**: `Esc` キー押下でキャンセルして閉じる。

### 7.2. 番号管理

- **挿入時**: 文書内で未使用の番号（または最大値+1）を自動採番して使用する。既存の番号をずらす処理（リアルタイム・リナンバリング）は行わない。
- **保存時**: ドキュメント全体をスキャンし、脚注番号を出現順（1, 2, 3...）に自動的にリナンバリング（整列）する。この機能は設定により無効化可能。

## 8. 特殊変換機能

### 8.1. テーブル変換貼り付け

- ExcelやGoogleスプレッドシート等のTSV/CSVテキストを `Ctrl + V` で貼り付けた際、自動的に Markdown テーブル形式に変換する。

### 8.2. YAML フロントマター連携

- ファイル冒頭の YAML ブロック（`---` で囲まれた範囲）を解析し、右側の編集パネルと同期する。
- 保存時に `updated` プロパティが存在する場合、現在日時に自動更新する。
