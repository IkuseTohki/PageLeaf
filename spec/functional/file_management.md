# 機能仕様：ファイル操作・管理

## 1. 基本操作

### 1.1. 新規作成

メモリ上に新しい Markdown ドキュメントを作成する。設定により、デフォルトのフロントマターテンプレートが自動的に挿入された状態で開始するものとする。

### 1.2. ファイル選択（開く）

ファイルダイアログを通じて既存の Markdown ファイル（.md, .markdown 等）を選択・展開する。文字コードは自動判別し、編集・保存時までその情報を保持する。

### 1.3. 保存（上書き保存）

現在の編集内容をファイルへ書き込む。

#### 保存時の自動加工

保存処理の実行時、以下の加工を自動的に行う。

- **メタデータ更新**: フロントマターに `updated` プロパティが存在する場合、現在日時で自動更新する
- **脚注整理**: 設定が有効な場合、本文中の脚注番号（`[^1]` 等）を出現順にリナンバリングする
- **文字コードの維持**: 原則として読み込み時に判別された文字コード（Encoding）を維持して書き出す。ただし、新規作成ファイルや判別不能な場合は UTF-8 (BOMなし) を使用する

#### 保存成功後の状態変化

保存が正常に完了した際、アプリケーションの状態を以下のように更新する。

- **Dirty フラグのクリア**: `IsDirty` を False に変更し、未保存インジケータを非表示にする
- **監視の制御**: 自身の書き込みによる外部変更検知が誤作動しないよう、ファイル監視サービスのタイムスタンプを更新する

## 2. 外部ファイル変更検知

表示中のファイルが外部（他のエディタ等）で変更された場合、自動的に検知して以下の処理を行う。

### 2.1. 通知と再読み込みの挙動

外部での変更検知時、現在の編集状態（IsDirty）に応じて確認ダイアログを表示する。

#### 未変更の場合 (IsDirty が False)

「外部でファイルが変更されました。最新の状態を反映するために再読み込みしますか？」と通知する。ユーザーが「はい」を選択した場合、最新の内容を読み込む。

#### 変更がある場合 (IsDirty が True)

「外部でファイルが変更されました。再読み込みして最新の状態を反映しますか？（現在の変更内容は失われます）」と警告する。

- **はい**: 外部の内容で上書きし、IsDirty を False にリセットする
- **いいえ**: 現在の編集内容を維持し、再読み込みをスキップする

### 2.2. 監視のライフサイクル

- **監視開始**: ファイルを開いた際、または新規作成後にはじめて保存したタイミングとする
- **監視停止**: ファイルを閉じた際、または別のファイルに切り替えたタイミングとする
- **自己変更の除外**: アプリケーション自身による保存操作時は、変更検知による再読み込みが走らないよう制御する

---

## 3. (削除) エクスポート機能

※将来的な拡張候補として残すが、現在はメニューから削除済みとする。
