# 機能仕様：エディタ機能

## 1. 概要

本アプリケーションのエディタは、Markdown ドキュメントの執筆効率を最大化するため、モダンなコードエディタに近い操作感と入力支援を提供することを目的とする。

## 2. 基本仕様 (Core Specifications)

本アプリケーションは、Markdown 執筆における視認性とレスポンスを最優先したエディタ環境を提供する。

### 2.1. エディタエンジンと基本表示

エディタの核には AvalonEdit (ICSharpCode.AvalonEdit) を採用し、モダンなコードエディタと同等の操作感を実現する。文字コードは UTF-8 (BOMなし) を標準とするが、既存ファイルの読み込み時には元のエンコーディングを最大限尊重する。

視覚的には、正確な行番号表示とウィンドウ幅に応じたワードラップ（折り返し）を提供し、システム設定で指定されたフォントおよびサイズをリアルタイムに適用する。

### 2.2. シンタックスハイライト

テーマ（ライト/ダーク）に応じて色が動的に切り替わるシンタックスハイライト機能を備える。これは単なる文字色変更ではなく、Markdown の論理構造を視覚的に強調することを目的とする。

具体的には、以下の要素を構造的に認識し、執筆中のユーザーがドキュメントの全体像を瞬時に把握できるよう支援する。

- **見出し**: `#` で始まる行
- **コードブロック**: ` ``` ` で囲まれた範囲
- **引用**: `>` で始まる行
- **リスト記号**: `*`, `-`, `+`, `1.` 等で始まる行
- **強調**: `**` (太字) または `*` (斜体) で囲まれた範囲
- **リンク/URL**: `[text](url)` 形式の記述

---

## 3. 入力支援機能 (Editing Support)

改行（`Enter`）や記号入力時に直前の構造を解析し、適切なプレフィックスや閉じ記号を自動挿入することで執筆を支援する。

### 3.1. オート・コンティニュー (リスト・引用の自動継続)

改行時に直前の行の構造を解析し、適切なプレフィックスを自動挿入する。

#### 継続の対象とルール

以下の要素が含まれる行で改行した際、その構造を次行へ継続する。

- **箇条書き / 番号付き**: 記号を継続する。番号リストの場合は数値をインクリメントする
- **タスクリスト**: 常に未完了状態 (`- [ ] `) で継続する
- **引用**: 引用記号 (`> `) を継続する

#### 終了挙動（プレフィックスの自動削除）

プレフィックスのみが存在し、コンテンツが空の状態で改行を押下した場合、オート・コンティニューを終了する。この際、現在の行にある記号やインデントを自動的に削除し、通常の空行へと変換する。これにより、ユーザーがバックスペース等を使わずにリスト編集を抜けられるようにする。

### 3.2. オート・ペアリング (記号の自動補完)

特定の記号を入力した際、対応する閉じ記号を自動挿入する。

- **対象記号**: `(`, `[`, `{`, `"`, `'`, `` ` ``
- **選択範囲の囲み**: テキスト選択中に記号を入力した場合、選択範囲の前後を記号で囲む

#### 閉じ記号のスキップ（オーバータイプ挙動）

自動補完により閉じ記号が挿入された直後、ユーザーが手動で同じ閉じ記号を入力した場合は、文字挿入を行わずカーソル移動のみを実行する。この挙動は、カーソル移動や他の文字入力が行われた時点で無効化する。

### 3.3. テーブル編集支援

Markdown テーブルの記述を効率化するため、構造を認識した自動整形とセル間移動を提供する。

#### 自動整形と構造維持

テーブル行（`|` を含む行）において `Enter` または `Tab` を押下した際、列幅を内容に合わせて自動調整し、パイプ（`|`）周囲のスペースを適切に配置する。また、ハイフンによる区切り行がない状態で 1 行目を作成して改行した場合は、区切り行を自動挿入する。

#### セル間ナビゲーション

`Tab`（次へ）または `Shift + Tab`（前へ）により、隣接するセルへカーソルを移動させる。移動先のセルの内容は全選択状態とし、即座に上書き入力が可能な状態にする。最終セルで `Tab` を押下した場合は、新しい行を自動生成して最初のセルへ移動する。

### 3.4. 脚注支援

#### インライン入力と一括挿入

`Ctrl + Alt + F` のショートカットにより、カーソル位置に脚注入力用のポップアップを表示する。ユーザーが脚注内容を入力して確定した際、本文への参照マーカー（`[^n]`）の挿入と、ファイル末尾への定義ブロックの追加を同時に実行する。

#### 番号管理と自動リナンバリング

入力時はその時点で未使用の最小数値を自動割り当てとする。ファイル保存時には、本文中の出現順にしたがって脚注番号を 1 から順に自動で振り直す（リナンバリング）。これにより、執筆順にかかわらずドキュメント全体で整合性の取れた番号配置を維持する。

---

## 4. 編集ワークフローとショートカット

効率的な執筆を支えるため、主要な Markdown 装飾や表示操作に対して直感的なショートカットキーを割り当てる。

| キー操作           | 機能           | 詳細動作                                                          |
| :----------------- | :------------- | :---------------------------------------------------------------- |
| `Ctrl + B`         | **太字**       | 選択範囲を `**` で囲む                                            |
| `Ctrl + I`         | _斜体_         | 選択範囲を `*` で囲む                                             |
| `Ctrl + Shift + X` | ~~打ち消し線~~ | 選択範囲を `~~` で囲む                                            |
| `Ctrl + Shift + C` | `コード`       | 選択範囲を `` ` `` で囲む                                         |
| `Ctrl + K`         | リンク挿入     | `[選択範囲]()` を作成し、カーソルを `()` 内へ移動                 |
| `Ctrl + L`         | タスクリスト   | `[ ]` (未完了) → `[x]` (完了) → `(なし)` の 3 段階トグル          |
| `Ctrl + 1〜6`      | 見出しレベル   | 行頭にレベルに応じた `#` を付与。現在のレベルと同じなら解除       |
| `Ctrl + Shift + Q` | 引用元の挿入   | 選択範囲を `[cite: ]` で囲む。カーソルは `]` の手前へ移動         |
| `Shift + Enter`    | 強制改ページ   | 印刷用タグ `<div style="page-break-after: always;"></div>` を挿入 |
| `Alt+Shift+←/→`    | 表示切替       | 編集モード(Markdown) と 閲覧モード(Viewer) を切り替える           |

---

## 5. 特殊変換・連携機能

エディタの基本機能に加え、外部データとの連携やメタデータ管理を円滑にするための特殊な変換・同期機能を提供する。

### 5.1. 引用元 (Citation) の独自拡張

Markdown 内に `[cite: 引用元テキスト]` と記述することで、HTML レンダリング時に `<cite>` タグへと変換する独自拡張を提供する。これは主に `<blockquote>` 内の末尾に配置され、出典を正しく示すために活用する。

### 5.2. データ貼り付けの自動変換

Excel や Google スプレッドシート等の TSV/CSV 形式のテキストをクリップボードから貼り付ける際、自動的に Markdown テーブル形式へと変換する機能を提供する。これにより、外部データから Markdown 文書への移行コストを大幅に削減する。

### 5.3. YAML フロントマター連携

ファイル冒頭の YAML ブロック（`---`）を解析し、フロントマター編集パネルとリアルタイムに同期する。これにより、テキストエディタと GUI パネルのどちらからでもメタデータを安全に操作可能とする。
