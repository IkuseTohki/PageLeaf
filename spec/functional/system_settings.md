# 機能仕様：システム設定

## 1. 概要

本ドキュメントでは、アプリケーションの動作環境、視覚的外観、および編集体験を制御するための設定仕様を定義する。これらの設定はユーザーによるカスタマイズを可能とし、アプリケーションの終了・再起動をまたいでその状態を維持（永続化）するものとする。

---

## 2. 設定の適用とバリデーション原則

システム設定の変更は、原則として「保存」ボタンの押下と同時に実行中のアプリケーションへ即時反映する。内部的には設定変更イベント（`SettingsChanged`）を発行し、各コンポーネントが動的に状態を更新する仕組みとする。

設定値の入力に際しては、システムの安定性を担保するため、以下の制約を厳守する。

- **数値入力**: 負の値や過度な巨大値を制限し、コードレベルで定義された有効範囲内に収める（例：フォントサイズ 1.0 〜 100.0 px、インデント幅 1 〜 32 文字）
- **不正な値の扱い**: バりデーションエラーが発生した場合は、保存処理を中断し、ユーザーに適切なエラーメッセージを表示するものとする

---

## 3. 設定カテゴリ詳細

### 3.1. 外観 (Appearance)

アプリケーション全体の視覚的テーマと、外部リソースの取得戦略を定義する。

- **テーマ (Theme)**: OS の配色設定に追従する「システム」、または「ライト」「ダーク」のいずれかに固定する設定。変更は UI 全体へ即座に適用する
- **ライブラリ読み込み先**: Highlight.js や Mermaid 等の依存リブラリを、アプリ内包の「ローカル」リソースから読み込むか、インターネット経由の「CDN」を使用するかを選択する

### 3.2. エディタ (Editor)

Markdown 執筆時の操作感と、ドキュメント構造の自動処理ルールを定義する。

- **フォントサイズ**: エディタ内のテキスト表示サイズを指定する（有効範囲：1.0 〜 100.0 px）
- **インデント設定**: タブキー押下時に「スペース」を挿入するか、またはタブ文字を使用するかを選択する。また、1 段落あたりの幅（1 〜 32 文字）を定義する
- **脚注設定**: 保存実行時に、本文内の脚注番号（`[^1]` 等）を出現順に 1 から振り直す「自動リナンバリング」の有効・無効を制御する
- **フロントマター設定**:
  - プレビュー画面最上部への「タイトル表示」の有無
  - 新規ファイル作成時における「テンプレートの自動挿入」の有無
  - 自動挿入時に付与するカスタムプロパティ（キーと初期値）の定義

### 3.3. 画像・ファイル (Image)

画像の貼り付けおよび外部ファイル連携に関する挙動を定義する。

- **保存先フォルダ**: 貼り付けられた画像ファイルを保存するディレクトリを指定する。パスは編集中の Markdown ファイルからの相対パスとして解決することを基本とする
- **ファイル名テンプレート**: `{Date}`, `{Time}`, `{FileName}` 等の変数を用い、保存時のファイル名命名規則を定義する

### 3.4. 表示・コード (Code)

プレビュー画面における構文強調（シンタックスハイライト）の挙動を定義する。

- **コードハイライト テーマ**: コードブロックに適用するカラーテーマを選択する
- **カスタムスタイルの適用**: CSS エディタでユーザーが設定したスタイル（フォントや背景色）を、コードハイライトテーマの設定よりも優先してプレビューに適用するかを制御する

### 3.5. 診断・ログ (Diagnostic)

トラブルシューティングおよび動作検証のためのログ出力ルールを定義する。

- **ログ出力レベル**: 出力する情報の最小レベル（標準、または開発用の詳細デバッグ情報）を指定する。変更は実行中のロガーへ即時反映する
- **ファイル出力**: ログをローカルディスク上のファイル（`logs/` ディレクトリ）に書き出すかの有効・無効を制御する

---

## 4. 設定の永続化仕様

設定データは YAML 形式のファイル (`settings.yaml`) として永続化する。

#### 保存場所

原則として実行ファイル（.exe）と同一の階層に保存する。アプリケーションの起動時にこのファイルを探索し、存在しない場合はデフォルト設定を用いて新規作成するものとする。

#### 更新の原子性

保存処理は、ファイルへの書き出し完了後にメモリ上の設定オブジェクトを更新し、システム全体に通知する。書き込みエラーが発生した場合は、メモリ上の既存設定を保護し、不整合な状態が発生しないように制御する。
