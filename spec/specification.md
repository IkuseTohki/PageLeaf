# Markdown CSS エディター 仕様書

## 1. 概要

本アプリケーションは、Markdown ドキュメントのデザイン（CSS）作成・編集に特化したデスクトップツールである。
ユーザーは、プレビュー画面でリアルタイムにスタイルの変化を確認しながら、GUI を通じて直感的に Markdown 用の CSS を作成・編集できる。
Markdown エディターとしての機能も兼ね備えており、スタイル確認用のテキスト編集も同一画面内でシームレスに行える。

## 2. 機能要件

### 2.1. ファイル操作

- **新規作成**: 新しい Markdown ファイルを作成する。
- **ファイル選択**: ファイルダイアログを通じて、既存の Markdown ファイル（.md, .markdown など）を開く。
- **保存**: 編集中の Markdown ファイルの内容を保存する。

### 2.2. 編集機能

- **Markdown 編集**: ユーザーはメイン表示・編集エリアで Markdown テキストを直接入力、編集できる。
- **モード切り替え**: 以下の 3 つのモードを切り替えることができる。
  - **ビューアーモード**: CSS を適用した閲覧専用モード。Markdown テキストは HTML として表示され、編集はできない。
  - **Markdown 編集モード**: Markdown テキストを表示し、直接編集できるモード。
  - **リアルタイム編集モード**: CSS を適用した HTML 表示だが、カーソルのある行だけ Markdown 形式で表示され、編集できるモード。カーソルが移動すると、その行は再度 HTML 表示に戻る。
  - **CSS 編集**: ビューアーモードで表示を確認しながら、Markdown の主要要素（見出し、段落、リストなど）のスタイル（フォント、色、余白など）を GUI で編集できる。
    - **フォントサイズ指定**: 数値入力および選択が可能なドロップダウン（Editable ComboBox）形式とする。
    - **単位の統合管理**: 「全体」タブで共通の単位（px, em, %）を選択し、各要素の設定にはこの単位が適用される。
    - **単位変換**: 共通単位を変更した際、既存の設定値は 16px を基準とした近似値に自動変換され、見た目の大きさが維持される。
  - **CSS 管理**: 作成した CSS の保存、読み込み、削除、および適用する CSS の選択ができる。
    - **設定のリセット**: 編集中のスタイルを破棄し、最後に保存された（あるいはファイルにある）状態に設定を戻す機能を提供する。
- **画像貼り付け**: クリップボードからの画像貼り付けに対応する（ショートカットキー: `Ctrl+Shift+V`）。
  - **対象データ**: ビットマップ画像データ、およびクリップボード上の画像ファイル。
  - **自動保存**: 貼り付け時、クリップボードの内容を指定された保存先に画像ファイルとして自動保存する。
  - **リンク挿入**: 保存した画像への相対パスを Markdown 形式（`![image](path/to/image.png)`）でエディターに挿入する。
- **編集支援機能**:
  - **オートインデント**: 改行時に前の行のインデント（空白）を自動的に引き継ぐ。
  - **オートリスト**: リスト形式（`*`, `-`, `+`, `1.` 等）の行で改行した際、次の行に同じリスト記号を自動挿入する。記号のみの行で改行した場合はリストを終了する。
  - **自動補完 (ペア挿入)**: 括弧（`()`, `[]`, `{}`）や引用符（`"`, `'`）の入力時、対となる記号を自動挿入し、カーソルを間に配置する。
  - **文字装飾**: テキスト選択中に以下のショートカットを入力した際、選択範囲を記号で囲む。選択範囲がない場合は記号ペアを挿入し、カーソルを中央に移動する。
    - **太字**: `Ctrl + B` → `**`
    - **イタリック**: `Ctrl + I` → `*`
    - **打ち消し線**: `Ctrl + Shift + X` → `~~`
    - **インラインコード**: `Ctrl + Shift + C` → `` ` ``
    - **リンク**: `Ctrl + K` → `[]()`
    - **見出し**: `Ctrl + 1~6` → `#` ～ `######`
  - **選択範囲の囲み**: テキスト選択中に記号（`*`, `_`, `~`, `` ` `` 等）を入力した際、選択範囲をその記号で囲む。
  - **コードブロック自動閉じ**: ` ``` ` を入力して改行した際、閉じ記号の ` ``` ` を自動的に挿入する。
  - **リスト操作**: リスト行で `Tab` を押すとインデントを深くし、`Shift + Tab` で浅くする。
  - **テーブル変換貼り付け**: Excel やスプレッドシートからコピーしたデータ（TSV 形式）を貼り付ける際、Markdown 形式のテーブルに自動変換して挿入する。

### 2.3. 表示機能

- **メイン表示・編集エリア**: Markdown テキストの表示および編集を行う単一のコンポーネント。現在のモードに応じて表示内容と編集挙動が変化する。
- **CSS 編集パネル**: CSS の作成・編集を行うための UI 要素。
- **外部ファイル変更検知**: 表示中の Markdown ファイルが外部で変更された場合、自動的に内容を再読み込みし、表示を更新する。
- **CSS 切り替え**:
  - ユーザーはプルダウンメニューから適用する CSS スタイルを選択し、メイン表示・編集エリア（ビューアーモード、リアルタイム編集モード時）のスタイルを動的に変更できる。
  - アプリケーション起動時に、特定のディレクトリ（例: `styles/`）から利用可能な CSS ファイルを読み込み、プルダウンメニューにリスト表示する。

### 2.4. エクスポート機能

編集中の Markdown コンテンツ、または表示中の Markdown コンテンツを以下の形式でエクスポートできる。

- **HTML**: Markdown を HTML 形式でエクスポートする。
- **PDF**: Markdown を PDF 形式でエクスポートする。
- **Word (docx)**: Markdown を Microsoft Word (docx) 形式でエクスポートする。
- **画像 (PNG)**: Markdown の表示内容を画像 (PNG) 形式でエクスポートする。

## 3. 画面構成

### 3.1. メインウィンドウ

- **ツールバー**:

### 3.2. 設定画面

- **目的**: アプリケーションの各種設定を行う画面。
- **機能**:
  - 画像貼り付け設定:
    - **保存先パス**: Markdown ファイルからの相対パスで指定（デフォルト: `images/`）。
    - **ファイル名テンプレート**: 貼り付け時のファイル名規則（日時、Markdown ファイル名等の変数を使用可能）。
  - その他のアプリケーション設定（将来的な拡張を考慮）。
- **永続化**: 設定内容はアプリケーション終了後も保持される。

## 4. 採用技術

- **開発言語**: C#
- **プラットフォーム**: .NET 8.0 (Windows)
- **フレームワーク**: WPF (Windows Presentation Foundation)
- **デザインパターン**: MVVM (Model-View-ViewModel)
- **DI コンテナ**: Microsoft.Extensions.DependencyInjection

## 5. 設計・実装ガイドライン

保守性とテスト容易性を高めるため、以下のガイドラインを厳守する。

### 5.1. アーキテクチャ (レイヤー分離)

- **依存性のルール**: 依存関係は常に外側（View）から内側（Domain/Service）へ向かう一方向とする。
- **Use Case 層の活用**: 複雑なビジネスフローやアプリケーションの実行フローは ViewModel に直接記述せず、Use Case クラスに抽出する。
- **DI の徹底**: サービス間の依存関係はインターフェースを介して DI コンテナにより解決し、ユニットテストでモック可能にする。

### 5.2. MVVM の純粋性

- **WPF 依存の排除**: ViewModel は純粋な C# クラス (POCO) であるべきで、`System.Windows` 名前空間（GridLength, Brush, Visibility 等）に直接依存してはならない。
- **型変換の責務**: UI 固有の型への変換は View 側の Converter で行い、ViewModel はプリミティブ型（double, bool, string 等）のみを公開する。
- **コードビハインドの最小化**: View のロジックは可能な限り Behavior や添付プロパティとして抽出し、コードビハインドを空に保つ。

### 5.3. UI リソース管理

- **スタイルの共通化**: フォント、色、マージン等の見た目に関する定義はインラインで記述せず、必ず `Styles.xaml` に共通スタイルとして定義し、再利用する。
- **コンバーターの集約**: カスタムコンバーターは `Converters.xaml` に集約し、アプリケーション全体で一貫して使用する。

### 5.4. 品質担保

- **テスト駆動開発 (TDD)**: 新機能の追加やロジックの変更時は、まずテストコードを作成し、その後に実装を行う。
- **例外ハンドリング**: 致命的なエラーはグローバル例外ハンドラーで捕捉し、ユーザーに詳細情報を通知（コピー可能）した上で、安全にアプリケーションを終了させる。

## 6. その他

- **文字コード**: ファイルの読み書きは UTF-8 を基本とする。
- **エラーハンドリング**: ファイルの読み込み失敗や、サポートされていないファイル形式が選択された場合には、適切なエラーメッセージをユーザーに表示する。
- **設定の永続化**: ユーザーが選択した CSS スタイルやモードなどの設定は、アプリケーション終了後も保持される。
