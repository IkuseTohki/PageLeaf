# Markdown CSS エディター 仕様書

## 1. 概要

本アプリケーションは、Markdown ドキュメントのデザイン（CSS）作成・編集に特化したデスクトップツールである。
ユーザーは、プレビュー画面でリアルタイムにスタイルの変化を確認しながら、GUI を通じて直感的に Markdown 用の CSS を作成・編集できる。
Markdown エディターとしての機能も兼ね備えており、スタイル確認用のテキスト編集も同一画面内でシームレスに行える。

## 2. 機能要件

### 2.1. ファイル操作

- **新規作成**: 新しい Markdown ファイルを作成する。
- **ファイル選択**: ファイルダイアログを通じて、既存の Markdown ファイル（.md, .markdown など）を開く。
- **保存**: 編集中の Markdown ファイルの内容を保存する。

### 2.2. 編集機能

#### Markdown 編集

ユーザーはメイン表示・編集エリアで Markdown テキストを直接入力、編集できる。

#### モード切り替え

以下の 2 つのモードを切り替えることができる。

- **ビューアーモード**: CSS を適用した閲覧専用モード。Markdown テキストは HTML として表示され、編集はできない。
- **Markdown 編集モード**: Markdown テキストを表示し、直接編集できるモード。
- **切り替え操作**: ショートカットキー（`Alt+Shift+←/→`）または画面右上のフローティングボタン（ペン/目アイコン）で切り替える。切り替え後は自動的に対象エリアへフォーカスが移動する。

#### 目次 (TOC) 機能

編集中の Markdown から見出し（H1〜H3）を抽出し、目次リストを表示する。

- **ジャンプ機能**: 目次アイテムを選択すると、現在のモードに応じて適切な位置（編集モードなら該当行、ビューアーモードなら該当セクション）へスクロールする。

#### CSS 編集

ビューアーモードで表示を確認しながら、Markdown の主要要素（見出し、段落、リストなど）のスタイル（フォント、色、余白など）を GUI で編集できる。

- **フォントサイズ指定**: 数値入力および選択が可能なドロップダウン（Editable ComboBox）形式とする。
- **単位の統合管理**: 「全体」タブで共通の単位（px, em, %）を選択し、各要素の設定にはこの単位が適用される。
- **単位変換**: 共通単位を変更した際、既存の設定値は 16px を基準とした近似値に自動変換され、見た目の大きさが維持される。

#### CSS 管理

作成した CSS の保存、読み込み、削除、および適用する CSS の選択ができる。これらの機能は CSS 編集パネルの上部に集約される。

- **新規作成**: CSS 選択ドロップダウンから新しい CSS ファイルを作成できる。
- **設定のリセット**: 編集中のスタイルを破棄し、最後に保存された（あるいはファイルにある）状態に設定を戻す機能を提供する。

#### YAML フロントマター対応

Markdown ファイルの先頭にある YAML 形式のメタデータブロックを認識する。

- **プレビュー制御**: プレビュー画面ではフロントマターの生の YAML を表示せず、タイトル等のメタデータとして適切に処理、または非表示にする。
- **日付管理**:
  - **作成日 (created)**: 新規保存時に現在日時を自動挿入する。
  - **更新日 (updated)**: 上書き保存時に、すでにフロントマターが存在する場合のみ、現在日時を自動更新する。
- **テンプレート**: 新規作成時に、設定されたフロントマターを含むテンプレートを自動挿入する。

### 2.3. 表示機能

#### メイン表示・編集エリア

Markdown テキストの表示および編集を行う単一のコンポーネント。現在のモードに応じて表示内容と編集挙動が変化する。

#### CSS 編集パネル

CSS の作成・編集を行うための UI 要素。右側のサイドパネル上部に配置される。

#### フロントマター編集パネル

YAML フロントマターの内容を GUI で確認・編集するための UI 要素。右側のサイドパネル下部に配置され、キーと値のペアをリスト表示する。

#### 外部ファイル変更検知

表示中の Markdown ファイルが外部で変更された場合、自動的に内容を再読み込みし、表示を更新する。

#### CSS 切り替え

ユーザーは CSS 編集パネル内のプルダウンメニューから適用する CSS スタイルを選択し、ビューアーモード時のスタイルを動的に変更できる。

### 2.4. (削除) エクスポート機能

※将来的な拡張候補として残すが、現在はメニューから削除済み。

## 3. 画面構成

### 3.1. メインウィンドウ

- **メニューバー**: ファイル操作、設定、ヘルプ（バージョン情報）。
- **オーバーレイボタン**: 画面右上に配置された、表示モード切替および目次表示のためのフローティングボタン群。
- **CSS 編集パネル**: 画面右側（サイドパネル）の上部に配置。CSS 選択ドロップダウンと保存・リセットボタンを備える。
- **フロントマター編集パネル**: 画面右側（サイドパネル）の下部に配置。YAML フロントマターの内容を GUI で編集できる。

### 3.2. 設定画面

- **目的**: アプリケーションの各種設定を行う画面。
- **機能**:
  - コードハイライト設定（テーマ選択）。
  - 画像貼り付け設定（保存先パス、ファイル名テンプレート）。
  - エディタ設定（インデント等）。
- **永続化**: 設定内容はアプリケーション終了後も保持される。

## 4. 採用技術

- **開発言語**: C#
- **プラットフォーム**: .NET 8.0 (Windows)
- **フレームワーク**: WPF (Windows Presentation Foundation)
- **デザインパターン**: MVVM (Model-View-ViewModel)
- **DI コンテナ**: Microsoft.Extensions.DependencyInjection

## 5. 設計・実装ガイドライン

保守性とテスト容易性を高めるため、以下のガイドラインを厳守する。

### 5.1. アーキテクチャ (レイヤー分離)

- **依存性のルール**: 依存関係は常に外側（View）から内側（Domain/Service）へ向かう一方向とする。
- **Use Case 層の活用**: 複雑なビジネスフローやアプリケーションの実行フローは ViewModel に直接記述せず、Use Case クラスに抽出する。
- **DI の徹底**: サービス間の依存関係はインターフェースを介して DI コンテナにより解決し、ユニットテストでモック可能にする。

### 5.2. MVVM の純粋性

- **WPF 依存の排除**: ViewModel は純粋な C# クラス (POCO) であるべきで、`System.Windows` 名前空間（GridLength, Brush, Visibility 等）に直接依存してはならない。
- **型変換の責務**: UI 固有の型への変換は View 側の Converter で行い、ViewModel はプリミティブ型（double, bool, string 等）のみを公開する。
- **コードビハインドの最小化**: View のロジックは可能な限り Behavior や添付プロパティとして抽出し、コードビハインドを空に保つ。

### 5.3. UI リソース管理

リソース定義の循環参照を防ぎ、保守性を高めるため、以下の役割ごとにリソースファイルを分割・管理する。

- **Colors.xaml**: アプリケーション全体で使用する色・ブラシ定義（原色、テーマカラーなど）。
- **Icons.xaml**: ベクターアイコン（Geometry）の定義。
- **Converters.xaml**: IValueConverter などのコンバーター定義。
- **ControlStyles.xaml**: ボタン、トグルスイッチなどの基本的なコントロールスタイル。
- **DataTemplates.xaml**: リストアイテムやコンテンツ表示用のデータテンプレート。
- **Styles.xaml**: その他の複合的なスタイル定義や、上記リソースを組み合わせたスタイル。

**ルール**

- 原則として、View 内のインラインスタイル (`<Button.Style>...`) は避け、上記リソースファイルに定義して `StaticResource` で参照する。
- リソースファイルの読み込み順序（依存関係）に注意する（例: `Colors.xaml` -> `ControlStyles.xaml`）。

### 5.4. 品質担保

- **テスト駆動開発 (TDD)**: 新機能の追加やロジックの変更時は、まずテストコードを作成し、その後に実装を行う。
- **例外ハンドリング**: 致命的なエラーはグローバル例外ハンドラーで捕捉し、ユーザーに詳細情報を通知（コピー可能）した上で、安全にアプリケーションを終了させる。

## 6. その他

- **文字コード**: ファイルの読み書きは UTF-8 を基本とする。
- **エラーハンドリング**: ファイルの読み込み失敗や、サポートされていないファイル形式が選択された場合には、適切なエラーメッセージをユーザーに表示する。
- **設定の永続化**: ユーザーが選択した CSS スタイルやモードなどの設定は、アプリケーション終了後も保持される。
