# Markdown CSS エディター 仕様書

## 1. 概要

本アプリケーションは、Markdown ドキュメントのデザイン（CSS）作成・編集に特化したデスクトップツールである。
ユーザーは、プレビュー画面でリアルタイムにスタイルの変化を確認しながら、GUI を通じて直感的に Markdown 用の CSS を作成・編集できる。
Markdown エディターとしての機能も兼ね備えており、スタイル確認用のテキスト編集も同一画面内でシームレスに行える。

## 2. 機能要件

### 2.1. ファイル操作

- **新規作成**: 新しい Markdown ファイルを作成する。
- **ファイル選択**: ファイルダイアログを通じて、既存の Markdown ファイル（.md, .markdown など）を開く。
- **保存**: 編集中の Markdown ファイルの内容を保存する。

### 2.2. 編集機能

#### Markdown 編集

ユーザーはメイン表示・編集エリアで Markdown テキストを直接入力、編集できる。
本エディタは AvalonEdit を採用しており、モダンなコードエディタと同等の編集支援を提供する。
詳細は [エディタ機能詳細仕様書](editor_specification.md) を参照。

- **リアルタイム・シンタックスハイライト**: 見出し、強調、コード、引用、リンク等をエディタ上で色分け表示し、構造を視覚的に把握しやすくする。
- **入力支援機能**:
  - **オート・コンティニュー**: リスト（箇条書き、番号付き、タスク）や引用行での改行時に、マーカーを自動継続する。
  - **オート・ペアリング**: 括弧や引用符の自動補完、および選択範囲の囲み機能。
  - **ショートカット**: 太字、斜体、リンク挿入、タスクリストのトグル（`Ctrl+L`）等のショートカットを提供。
- **改ページ挿入**: `Shift+Enter` を押下することで、印刷時に強制的に改ページを行うためのタグ（`<div style="page-break-after: always;"></div>`）をカーソル位置に挿入する。

#### モード切り替え

以下の 2 つのモードを切り替えることができる。

- **ビューアーモード**: CSS を適用した閲覧専用モード。Markdown テキストは HTML として表示され、編集はできない。
- **Markdown 編集モード**: Markdown テキストを表示し、直接編集できるモード。
- **切り替え操作**: ショートカットキー（`Alt+Shift+←/→`）または画面右上のフローティングボタン（ペン/目アイコン）で切り替える。切り替え後は自動的に対象エリアへフォーカスが移動する。

#### 目次 (TOC) 機能

編集中の Markdown から見出し（H1〜H3）を抽出し、目次リストを表示する。

- **ジャンプ機能**: 目次アイテムを選択すると、現在のモードに応じて適切な位置（編集モードなら該当行、ビューアーモードなら該当セクション）へスクロールする。

#### CSS 編集

ビューアーモードで表示を確認しながら、Markdown の主要要素（タイトル、見出し、段落、リストなど）のスタイル（フォント、色、余白、行間など）を GUI で編集できる。

- **段落設定**: 行間（line-height）、段落下の余白（margin-bottom）、行頭インデント（text-indent）を個別に調整可能。
- **フォントサイズ・数値指定**:
  - 数値入力（候補リストからの選択も可能）と、単位選択が一体となったコントロールを採用する。
  - 数値エリアには、増減を行うための上下ボタンを備える。
  - 候補選択用の矢印や上下ボタンは、マウスオーバー時のみ表示されるミニマルなデザインとする。
- **個別単位管理**: 項目ごとに単位（px, em, %）を個別に選択・変更できる。
- **単位変換**: 単位を切り替えた際、既存の数値は 16px を基準とした近似値に自動変換され、見た目の大きさが維持される。サポートされていない単位が直接入力された場合は変換を行わない。

#### CSS 管理

作成した CSS の保存、読み込み、削除、および適用する CSS の選択ができる。これらの機能は CSS 編集パネルの上部に集約される。

- **新規作成**: CSS 選択ドロップダウンから新しい CSS ファイルを作成できる。
- **設定のリセット**: 編集中のスタイルを破棄し、最後に保存された（あるいはファイルにある）状態に設定を戻す機能を提供する。

#### YAML フロントマター対応

Markdown ファイルの先頭にある YAML 形式のメタデータブロックを認識する。

- **プレビュー制御**:
  - プレビュー画面ではフロントマターの生の YAML を表示せず、タイトル等のメタデータとして適切に処理、または非表示にする。
  - **タイトル表示設定**: 設定により、フロントマターの `title` をプレビューの最上部に独立した要素（本文の CSS とは独立したスタイル設定が可能）として表示できる。値が空の場合は表示されない。
- **予約プロパティ**: 以下のキーはシステムによって特別な意味を持つ。
  - **`title`**: 文書のタイトル。プレビュー表示設定が ON の場合、表示対象となる。
  - **`css`**: 適用する CSS ファイル名（拡張子 `.css` は省略可）。ファイルを開いた際に、指定された CSS が存在すれば自動的に選択・適用される。
  - **`syntax_highlight`**: コードハイライトのテーマ名。設定画面の指定よりも優先して適用される。
- **日付管理**:
  - **作成日 (created)**: 新規保存時に現在日時を自動挿入する。
  - **更新日 (updated)**: 上書き保存時に、すでにフロントマターが存在する場合のみ、現在日時を自動更新する。
- **テンプレート**: 新規作成時に、設定されたフロントマターを含むテンプレートを自動挿入する。

### 2.3. 表示機能

#### メイン表示・編集エリア

Markdown テキストの表示および編集を行う単一のコンポーネント。現在のモードに応じて表示内容と編集挙動が変化する。

#### CSS 編集パネル

CSS の作成・編集を行うための UI 要素。右側のサイドパネル上部に配置される。
Markdown の主要要素（タイトル、見出し1〜6、段落、リスト、引用、コード等）ごとにタブ分けされ、フォントや余白を GUI で調整できる。各タブの左上には、未保存の変更があることを示すインジケータ（ドット）が表示される。

#### 未保存変更の可視化 (Dirty インジケータ)

ユーザーがテキストまたは CSS 設定に変更を加えた際、視覚的に通知する。

- **エディタ側**: 画面右上のモード切替ボタンのアイコン左上に、オレンジ色のドットを表示する。
- **CSS パネル側**: 変更があったカテゴリのタブアイコン左上に、タブの文字色と同期したドットを表示する。

#### フロントマター編集パネル

YAML フロントマターの内容を GUI で確認・編集するための UI 要素。右側のサイドパネル下部に配置され、キーと値のペアをリスト表示する。
`title` などの主要な値が未入力の場合、入力を促すプレースホルダーを表示する。

#### 外部ファイル変更検知

表示中の Markdown ファイルが外部で変更された場合、自動的に内容を再読み込みし、表示を更新する。

#### CSS 切り替え

ユーザーは CSS 編集パネル内のプルダウンメニューから適用する CSS スタイルを選択し、ビューアーモード時のスタイルを動的に変更できる。

### 2.4. (削除) エクスポート機能

※将来的な拡張候補として残すが、現在はメニューから削除済み。

### 2.5. チートシート機能

ユーザーが Markdown の記法やアプリケーションのショートカットキーを素早く確認できるよう、ヘルプメニューから呼び出せる「チートシート（クイックリファレンス）」ウィンドウを提供する。

- **モードレス表示**: メインウィンドウでの作業を妨げないよう、独立したウィンドウ（モードレス）として表示する。
- **コンテンツ**:
  - **Markdown 記法**: 一般的な Markdown 記法に加え、本アプリ独自の「強制改ページ」機能などの説明を表示する。
  - **ショートカット**: ファイル操作、編集、表示切り替えなどの主要なキーボードショートカット一覧を表示する。

## 3. 画面構成

### 3.1. メインウィンドウ

- **メニューバー**: ファイル操作、設定、ヘルプ（バージョン情報、チートシート）。
- **オーバーレイボタン**: 画面右上に配置された、表示モード切替および目次表示のためのフローティングボタン群。
- **CSS 編集パネル**: 画面右側（サイドパネル）の上部に配置。CSS 選択ドロップダウンと保存・リセットボタンを備える。
- **フロントマター編集パネル**: 画面右側（サイドパネル）の下部に配置。YAML フロントマターの内容を GUI で編集できる。

### 3.2. 設定画面

- **目的**: アプリケーションの各種設定を行う画面。
- **機能**:
  - コードハイライト設定（テーマ選択）。
  - ライブラリ（Highlight.js, Mermaid）の読み込み先設定（ローカル / CDN）。
  - 画像貼り付け設定（保存先パス、ファイル名テンプレート）。
  - **エディタ設定**:
    - フォントサイズの指定。
    - インデント設定（幅、スペース/タブ切り替え）。
  - **フロントマター設定**:
    - 新規作成時にテンプレート（フロントマター）を自動挿入するかどうかの切り替え。
    - 挿入されるプロパティの定義:
      - **標準プロパティ** (削除不可): `title`, `created`, `updated`, `css`, `syntax_highlight`
      - **追加プロパティ**: ユーザーが任意に定義可能なプロパティ。
    - 初期値には変数（`{Now}`: 現在日時、 `{Date}`: 現在日付、 `{Time}`: 現在時刻）が使用可能。
- **永続化**: 設定内容はアプリケーション終了後も保持される。設定ファイル（`settings.json`）は、実行ファイル（.exe）と同じディレクトリに保存される。

### 3.3. チートシートウィンドウ

- **目的**: ユーザー支援のためのリファレンス表示。
- **構成**: タブ切り替え式（Markdown / ショートカット）。
- **挙動**: メインウィンドウとは独立して移動・リサイズが可能。すでに開かれている状態で再度呼び出された場合は、最前面に表示（Activate）される。

## 4. 採用技術

- **開発言語**: C#
- **プラットフォーム**: .NET 8.0 (Windows)
- **フレームワーク**: WPF (Windows Presentation Foundation)
- **エディタコンポーネント**: AvalonEdit
- **デザインパターン**: MVVM (Model-View-ViewModel)
- **DI コンテナ**: Microsoft.Extensions.DependencyInjection

## 5. 設計・実装ガイドライン

保守性とテスト容易性を高めるため、以下のガイドラインを厳守する。

### 5.1. アーキテクチャ (レイヤー分離)

- **依存性のルール**: 依存関係は常に外側（View）から内側（Domain/Service）へ向かう一方向とする。
- **Use Case 層の活用**: 複雑なビジネスフローやアプリケーションの実行フローは ViewModel に直接記述せず、Use Case クラスに抽出する。
- **DI の徹底**: サービス間の依存関係はインターフェースを介して DI コンテナにより解決し、ユニットテストでモック可能にする。

### 5.2. MVVM の純粋性

- **WPF 依存の排除**: ViewModel は純粋な C# クラス (POCO) であるべきで、`System.Windows` 名前空間（GridLength, Brush, Visibility 等）に直接依存してはならない。
- **型変換の責務**: UI 固有の型への変換は View 側の Converter で行い、ViewModel はプリミティブ型（double, bool, string 等）のみを公開する。
- **コードビハインドの最小化**: View のロジックは可能な限り Behavior や添付プロパティとして抽出し、コードビハインドを空に保つ。

### 5.3. UI リソース管理

リソース定義の循環参照を防ぎ、保守性を高めるため、以下の役割ごとにリソースファイルを分割・管理する。

- **LightColors.xaml / DarkColors.xaml**: アプリケーション全体で使用する色・ブラシ定義。テーマ（ライト/ダーク）ごとに作成し、実行時に動的に差し替える。
- **Icons.xaml**: ベクターアイコン（Geometry）の定義。
- **Converters.xaml**: IValueConverter などのコンバーター定義。
- **ControlStyles.xaml**: ボタン、トグルスイッチなどの基本的なコントロールスタイル。
- **DataTemplates.xaml**: リストアイテムやコンテンツ表示用のデータテンプレート。
- **Styles.xaml**: その他の複合的なスタイル定義や、上記リソースを組み合わせたスタイル。

#### テーマとハイライトのアーキテクチャ

本アプリケーションでは、テーマ（ライト/ダーク）の切り替えを以下の原則に基づいて実装する。

1. **色のマスター (Master of Colors)**: 常に XAML リソース (`LightColors.xaml`, `DarkColors.xaml`) を正解とする。
2. **構造のマスター (Master of Rules)**: AvalonEdit のハイライトルール（正規表現等）は `Markdown.xshd` を正解とする。XSHD 内の色定義はフォールバック用として扱い、実行時は無視される。
3. **動的同期**: テーマ切り替え時、プログラム (Behavior) が XAML から色を取得し、AvalonEdit のメモリ上のハイライト定義 (`IHighlightingDefinition`) を動的に更新する。これにより、XSHD ファイルを増やすことなく、一貫したテーマ管理を実現する。

**ルール**

- 原則として、View 内のインラインスタイル (`<Button.Style>...`) は避け、上記リソースファイルに定義して `DynamicResource` で参照する。
- リソースファイルの読み込み順序（依存関係）に注意する（例: `Colors.xaml` -> `ControlStyles.xaml`）。

### 5.4. 品質担保

- **テスト駆動開発 (TDD)**: 新機能の追加やロジックの変更時は、まずテストコードを作成し、その後に実装を行う。
- **例外ハンドリング**: 致命的なエラーはグローバル例外ハンドラーで捕捉し、ユーザーに詳細情報を通知（コピー可能）した上で、安全にアプリケーションを終了させる。

### 5.5. ウィンドウ管理

独立した機能ウィンドウ（設定画面、チートシート等）の表示には `IWindowService` を使用する。

- **目的**: ViewModel から直接 View (Window) を生成・操作することを避け、テスト容易性を確保する。また、ウィンドウの重複起動防止（Activate制御）を集約する。
- **インターフェース**: `ShowWindow<TViewModel>()`, `CloseWindow<TViewModel>()` などのメソッドを提供する。

## 6. その他

- **文字コード**: ファイルの読み書きは UTF-8 を基本とする。
- **エラーハンドリング**: ファイルの読み込み失敗や、サポートされていないファイル形式が選択された場合には、適切なエラーメッセージをユーザーに表示する。
- **設定の永続化**: ユーザーが選択した CSS スタイルやモードなどの設定は、アプリケーション終了後も保持される。
