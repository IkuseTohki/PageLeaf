# 2. 脚注（注釈）機能の実装とUX

日付: 2026-01-30

## ステータス

承認済み (Accepted)

## 背景 (Context)

Markdown ドキュメント、とくに技術文書や論文調の記事を作成する際、脚注（Footnotes）は頻繁に使用される機能である。しかし、Markdown の標準的な脚注記法には以下の課題がある。

1. **視線移動のコスト**: 本文中に参照マーカー `[^1]` を書き、ドキュメントの末尾までスクロールして定義 `[^1]: 内容` を書くという往復作業が必要となり、執筆のフロー（集中状態）が途切れる。
2. **番号管理の煩雑さ**: 執筆中に脚注を追加・削除・並べ替えを行うと、番号 `[^n]` が前後したり欠番になったりする。手動での修正は負担が大きい。
3. **デザイン調整**: 脚注の見た目（フォントサイズや区切り線）を簡単に調整したいニーズがある。

## 決定 (Decision)

### 1. インライン入力 UX (Inline Input Experience)

「執筆のフローを妨げない」ことと「入力の確実性」を両立するため、以下の **Light-dismiss（自動クローズ）** 挙動を採用する。

- **入力フロー**:
  1. ショートカットキー（推奨: `Ctrl+Alt+F`）を押下する。
  2. エディタ上のカーソル位置直下に、**コンパクトな入力ポップアップ**を表示する。
  3. ユーザーが注釈内容を入力し、`Enter` で確定する。
  4. システムは自動的に以下を行う：
     - 本文のカーソル位置に参照マーカー `[^n]` を挿入する。
     - ドキュメント末尾に定義行 `[^n]: 内容` を追記する。
  5. ポップアップが閉じ、カーソルは本文の元の位置から移動しない。

- **UI の挙動とフォーカス制御**:
  - **排他的フォーカス**: 表示中は入力欄がキーボードフォーカスを保持し、Tab キーによる移動もポップアップ内に限定する。
  - **確定・キャンセル**:
    - `Enter`: 確定して挿入処理を実行し、閉じる。
    - `Esc`: 何もせず閉じる。
    - **フォーカスロスト（外側をクリック）**: ユーザーがポップアップの外（本文やメニュー等）をクリックした場合、**「キャンセル」と見なして即座にポップアップを閉じる。** これにより、入力途中の窓が放置されるリスクを排除する。

- **UI デザイン**:
  - WPF の `Popup` コントロール等を使用し、モダンで軽量なデザインとする。
  - 視線移動を最小限にするため、入力欄はカーソルのすぐ近くに配置する。

### 2. 番号管理とリナンバリング (Numbering Strategy)

エディタとプレビュー間の番号不整合を防ぎつつ、編集中の副作用を最小化するため、以下の戦略を採る。

- **挿入時の挙動**:
  - リアルタイムでの全置換（リナンバリング）は行わない（Undo 履歴の汚染や意図しない差分発生を防ぐため）。
  - 新規挿入時は、文書内で一意となる番号（未使用の最小値または最大値 + 1）を自動採番して使用する。
- **保存時の挙動 (On Save)**:
  - **ファイルの保存時**に、ドキュメント内のすべての脚注番号を出現順（`1, 2, 3...`）に自動的に振り直す（リナンバリング）。
  - これにより、Git 等での管理上も整列された状態が保たれ、プレビューとの不整合も解消される。
- **設定オプション**:
  - 「保存時に脚注番号を振り直す」設定項目を用意し、ユーザーがこの挙動を無効化（OFF）できるようにする（デフォルトは ON）。

### 3. CSS 編集機能 (CSS Customization)

CSS 編集パネルに「注釈 (Footnotes)」タブを新設し、GUI で以下のスタイル調整を可能にする。

- **本文中の参照マーカー (`.footnote-ref`)**:
  - 文字色、フォントウェイト（太字）、括弧の有無（`[1]` or `1`）。
- **注釈エリア全体 (`.footnotes`)**:
  - フォントサイズ（本文より小さくする等の調整）、文字色。
  - 上部マージン（本文との距離）。
  - 区切り線（Border-Top）のスタイル、太さ、色。
- **リストアイテム (`.footnotes li`)**:
  - 行間。
  - 戻るリンク（`↩`）の表示/非表示。

## 結果 (Consequences)

- **メリット**:
  - ユーザーはカーソル位置から目を離さずに注釈を完結でき、執筆効率が大幅に向上する。
  - 面倒な番号管理から解放され、常に綺麗な連番が維持される。
  - CSS の知識がなくても、論文や記事に適した脚注デザインを作成できる。
- **デメリット / 考慮事項**:
  - **実装コスト**: エディタ座標に合わせた Popup 表示制御やフォーカス管理の実装が必要。
  - **テキスト処理**: 保存時のリナンバリング処理において、Markdown の構文解析（正規表現等）を正確に行い、コードブロック内の文字列などを誤って置換しないよう注意が必要。
