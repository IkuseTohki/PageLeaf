# ADR: ロギング初期化における循環依存の解消と責務分離

## ステータス

承認済み (Accepted)

## コンテキスト

アプリケーションの起動時（`OnStartup`）において、以下の循環依存の問題が発生していた。

1. ロギング（Serilog）を構成するためには、設定（`SettingsService`）からログレベルやファイル出力の有無を読み込む必要がある。
2. `SettingsService` をインスタンス化するためには、ロガー（`ILogger<SettingsService>`）が必要である。
3. `Host` の構築時、DIコンテナはロガーを先に作ろうとするが、設定読み込みのためにサービスプロバイダへアクセスしようとすると、まだ構築中のためデッドロックまたは例外が発生する。

一時的な解決策として `App.xaml.cs` 内で YAML ファイルを直接文字列として検索する「先行読み込み」ロジックを実装したが、以下の問題が残った。

- `App.xaml.cs` がファイル I/O や YAML 構造に関する知識を持ちすぎている（責務過多）。
- 設定のキー（"MinimumLevel" 等）がマジックストリングとして分散しており、変更に弱い。

## 決定事項 (Decision)

### 1. `LoggingBootstrapper` の導入

ロギングの初期構成に関する責務を `App.xaml.cs` から切り離し、専用のクラス `LoggingBootstrapper`（Infrastructure 層）に委譲する。このクラスは以下の責務を持つ。

- 設定ファイル（`settings.yaml`）からの簡易的な先行読み込み。
- Serilog の `LoggerConfiguration` の構築。
- ログレベルの動的変更用スイッチ（`LoggingLevelSwitch`）の管理。

### 2. 先行読み込みロジックの堅牢化

YAML をテキストとしてパースする際、ハードコードされた文字列（"EnableFileLogging" 等）の使用を避け、`nameof(LoggingSettings.EnableFileLogging)` 等を利用してプロパティ名との同期を保証する。これにより、将来的なリネーム時のバグを防ぐ。

## 結果 (Consequences)

### メリット

- `App.xaml.cs` がすっきりし、本来の「起動シーケンスの管理」に集中できる。
- ロギング構成ロジックがカプセル化され、テストや変更が容易になる。
- 設定プロパティ名の変更がコンパイル時にチェック可能になり、保守性が向上する。

### デメリット

- `LoggingBootstrapper` というクラスが1つ増える。
- 先行読み込みはあくまで簡易的なものであり、複雑な YAML 構造の変化には完全に対応できない可能性がある（ただし、ログ設定はルート付近にあるためリスクは低い）。
